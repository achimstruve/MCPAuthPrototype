# =============================================================================
# serviceaccount.yaml - Kubernetes ServiceAccounts
# =============================================================================
#
# A ServiceAccount provides an identity for processes running in a pod.
# Every pod runs as SOME service account (the "default" SA if none is
# specified). By creating dedicated SAs, we can:
#
# 1. Control what GCP services the pod can access (via Workload Identity)
# 2. Limit Kubernetes API access (via RBAC, though we don't use that here)
# 3. Audit which workload performed which action
#
# We create TWO service accounts with different purposes:
#
# 1. mcp-server SA:
#    - Used by the MCP server Deployment pods
#    - Bound to the mcp-server@mcpauthprototype GCP SA via Workload Identity
#    - Currently has no GCP permissions (the server doesn't call GCP APIs)
#    - The binding exists for future use (Cloud Logging, Cloud Trace, etc.)
#
# 2. eso-service-account SA:
#    - Used by the SecretStore resource (not by pods directly)
#    - Bound to eso-secret-accessor@mcpauthprototype GCP SA
#    - Has roles/secretmanager.secretAccessor permission in GCP
#    - This is what allows ESO to read our JWT signing key from Secret Manager
#
# The Workload Identity annotation (iam.gke.io/gcp-service-account) tells
# GKE: "When a pod using this K8s SA requests GCP credentials, give it
# temporary credentials for the specified GCP service account."
# No key files, no stored secrets â€” just an IAM trust relationship.
# =============================================================================

# ---------------------------------------------------------------------------
# MCP Server ServiceAccount
# ---------------------------------------------------------------------------
{{- if .Values.serviceAccount.mcp.create }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.serviceAccount.mcp.name }}
  labels:
    {{- include "mcp-server.labels" . | nindent 4 }}
  {{- with .Values.serviceAccount.mcp.annotations }}
  annotations:
    # The iam.gke.io/gcp-service-account annotation is the Workload Identity
    # link. It maps this K8s SA to a GCP SA. The corresponding IAM binding
    # (created in terraform/iam.tf) completes the trust chain.
    {{- toYaml . | nindent 4 }}
  {{- end }}
{{- end }}

---

# ---------------------------------------------------------------------------
# External Secrets Operator ServiceAccount
# ---------------------------------------------------------------------------
# IMPORTANT: If you already created this ServiceAccount manually during
# Phase 5, you have two options before running helm install:
#
#   Option 1: Delete the existing SA first:
#     kubectl delete sa eso-service-account -n mcp-prototype
#
#   Option 2: Set serviceAccount.eso.create=false in your values:
#     helm install --set serviceAccount.eso.create=false ...
#
# Either way, the SecretStore will reference the SA by name, and the
# Workload Identity annotation must be present for ESO to authenticate.
# ---------------------------------------------------------------------------
{{- if .Values.serviceAccount.eso.create }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.serviceAccount.eso.name }}
  labels:
    {{- include "mcp-server.labels" . | nindent 4 }}
  {{- with .Values.serviceAccount.eso.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
{{- end }}
