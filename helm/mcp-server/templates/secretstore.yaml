# =============================================================================
# secretstore.yaml - ESO Connection to GCP Secret Manager
# =============================================================================
#
# A SecretStore tells External Secrets Operator (ESO) HOW to connect to an
# external secret provider. It's the "connection configuration" — it doesn't
# fetch any specific secret, it just establishes the bridge.
#
# Think of it like a database connection string: it tells you WHERE the
# database is and HOW to authenticate, but not WHICH tables to query.
# The ExternalSecret resource (externalsecret.yaml) specifies WHAT to fetch.
#
# SecretStore vs ClusterSecretStore:
# - SecretStore: Namespace-scoped. Can only be used by ExternalSecrets in
#   the same namespace. More secure (follows least privilege).
# - ClusterSecretStore: Cluster-wide. Any namespace can reference it.
#   Convenient but violates namespace isolation.
#
# We use namespace-scoped SecretStore for security: the JWT signing key
# should only be accessible to resources in the mcp-prototype namespace.
#
# Authentication: Workload Identity
# Instead of storing a GCP service account key file (a long-lived secret
# that could be leaked), we use Workload Identity:
# 1. The SecretStore references a K8s ServiceAccount (eso-service-account)
# 2. That SA has a Workload Identity annotation linking it to a GCP SA
# 3. GKE automatically provides temporary GCP credentials to ESO
# 4. These credentials expire and are auto-rotated — nothing to manage
# =============================================================================

{{- if .Values.externalSecret.enabled }}
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: {{ .Values.externalSecret.secretStore }}
  labels:
    {{- include "mcp-server.labels" . | nindent 4 }}
spec:
  provider:
    # gcpsm = Google Cloud Platform Secret Manager
    # ESO supports many providers: AWS Secrets Manager, Azure Key Vault,
    # HashiCorp Vault, etc. The provider block configures the specific one.
    gcpsm:
      # The GCP project where our secrets are stored
      projectID: {{ .Values.gcp.projectId }}
      auth:
        workloadIdentity:
          # Cluster details needed for Workload Identity token exchange.
          # GKE uses these to verify the request is coming from the right cluster.
          clusterLocation: {{ .Values.gcp.clusterLocation }}
          clusterName: {{ .Values.gcp.clusterName }}
          # Reference to the K8s ServiceAccount that has the Workload Identity
          # annotation. ESO will "act as" this SA when calling GCP APIs.
          serviceAccountRef:
            name: {{ .Values.serviceAccount.eso.name }}
{{- end }}
